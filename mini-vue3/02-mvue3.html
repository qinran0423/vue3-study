<div id="app">
	<h3>{{title}}</h3>
</div>

<script>
	function reactive(obj) {
		return new Proxy(obj, {
			get(target, key) {
				console.log(`访问了数据${target} : ${key}  = ${target[key]}`);
				track(target, key);
				return target[key]
			},
			set(target, key, val) {
				console.log(`设置数据${target} : ${key}  为 ${val}`);
				target[key] = val
				trigger(target, key)
			}
		})
	}

	const effectStack = []
	// 添加副作用
	function effect(fn) {
		// 如果fn中用到了响应式得数据，当他们发生了变化，fn会再次执行
		// 称之为副作用函数
		const eff = function () {
			try {
				effectStack.push(eff);
				fn()
			} finally {
				effectStack.pop()
			}
		}
		// 执行一次，触发依赖收集
		eff();
		return eff;
	}


	// 依赖收集函数
	const targetMap = {}

	function track(target, key) {
		const effect = effectStack[effectStack.length - 1];
		if (effect) {
			let map = targetMap[target];
			if (!map) {
				map = targetMap[target] = {}
			}

			let deps = map[key]
			if (!deps) {
				deps = map[key] = [];
			}

			// 将副作用函数放入deps
			if (deps.indexOf(effect) === -1) {
				deps.push(effect)
			}
		}
	}


	function trigger(target, key) {
		const map = targetMap[target];
		if (map) {
			const deps = map[key]
			deps.forEach(dep => dep())
		}
	}

	function h(target, attr, children) {
		return {target, attr, children}
	}

	const Vue = {
		createApp(options) {
			const renderer = Vue.createRenderer({
				querySelector(selector) {
					return document.querySelector(selector)
				},
				insert(child, parent, achor) {
					parent.insertBefore(child, achor || null)
				},
				createElement(tag) {
					return document.createElement(tag)
				}
			});
			return renderer.createApp(options)
		},
		createRenderer({
			querySelector,
			insert,
			createElement
		}) {
			return {
				createApp(options) {
					return {
						mount(selector) {
							const parent = querySelector(selector);

							if (!options.render) {
								options.render = this.complie(parent.innerHTML);
							}

							// 兼容options api
							if (options.setup) {
								this.setupstate = options.setup()
							} else {
								this.data = options.data()
							}

							this.proxy = new Proxy(this, {
								get(target, key) {
									if (key in target.setupstate) {
										return target.setupstate[key]
									} else {
										return target.data[key]
									}
								},
								set(target, key, val) {
									if (key in target.setupstate) {
										target.setupstate[key] = val
									} else {
										target.data[key] = val
									}
								}
							})

							this.update = effect(() => {
								// const el = options.render.call(this.proxy)

								// parent.innerHTML = '';
								// // parent.appendChild(el);
								// insert(el, parent)

								const vnode = options.render.call(this.proxy);
								if(!this.isMounted) {
									const el = this.createElm(vnode);
									parent.innerHTML = '';
									insert(el, parent)

									this.isMounted = true;

								} else {
									this.patch(this._vnode, vnode)
								}

								this._vnode = vnode;
							})

							this.update()


						},
						createElm(vnode) {
							const el = createElement(vnode.tag);
							// todo props
							if(typeof vnode.children === 'string') {
								el.textContent = vnode.children
							} else {
								vnode.children.forEach(child => {
									insert(this.createElm(child), el)
								})
							}
							vnode.el = el
							return el
						},
						patch(n1, n2) {
							const el = n2.el = n1.el;
							// 判断双方是否是相同节点
							if(n1.tag === n2.tag) {
								const oldCh = n1.children;
								const newCh = n2.children;

								if(typeof oldCh === 'string') {
									if(typeof newCh === 'string') {
										if(oldCh !== newCh) {
											el.textContent = newCh
										}
									} else {
										el.textContent = ''
										newCh.forEach(child => insert(this.createElm(child), el))
									}
								} else {
									if(typeof newCh === 'string') {
										el.textContent = newCh
									} else {
										
									}
								}
							}
						},
						complie(template) {
							return function render() {
								// const h3 = document.createElement('h3');
								// h3.textContent = this.title;
								// return h3;
								return h('h3', null, this.title)
							}
						}
					}
				}
			}
		}
	}
</script>

<script>
	const {
		createApp
	} = Vue
	const app = createApp({

		setup() {
			const state = reactive({
				title: 'hello, vue3!!!'
			})

			setTimeout(() => {
				state.title = 'vue3, hello!!!'
			}, 2000);
			return state
		}
	})

	app.mount('#app')
</script>